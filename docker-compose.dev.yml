version: '3.8'

services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-devpassword}
      MONGO_INITDB_DATABASE: ${DB_NAME:-clbh_dev}
    ports:
      - "27017:27017"
    volumes:
      - mongo_dev_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    restart: unless-stopped
    environment:
      MONGO_URL: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-devpassword}@mongo:27017
      DB_NAME: ${DB_NAME:-clbh_dev}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      ADMIN_KEY: ${ADMIN_KEY:-dev-admin-key-not-secure}
      PYTHONUNBUFFERED: 1
      LOG_LEVEL: debug
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for hot-reloading
      - ./backend:/app/backend:ro
    depends_on:
      mongo:
        condition: service_healthy
    command: ["uvicorn", "server:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    restart: unless-stopped
    environment:
      REACT_APP_BACKEND_URL: ${REACT_APP_BACKEND_URL:-http://localhost:8000}
      CHOKIDAR_USEPOLLING: true
      WATCHPACK_POLLING: true
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for hot-reloading
      - ./frontend/src:/app/src:ro
      - ./frontend/public:/app/public:ro
      # Avoid mounting node_modules
      - /app/node_modules
    depends_on:
      backend:
        condition: service_healthy
    stdin_open: true
    tty: true

volumes:
  mongo_dev_data:
